# Nmap — Further (TryHackMe style)

> An in-depth look at scanning with **Nmap**, a powerful network scanning tool.

---

## Task 1 — Deploy

Press the green button to deploy the machine in the room (or start your AttackBox).
*No answer needed.*

---

## Task 2 — Introduction

**Why port scanning?**
Port scanning discovers which services/ports are listening on a target so you can plan enumeration and exploitation. Each network service listens on a port — for example HTTP on `80`, HTTPS on `443`, SMB on `445`, etc. Computers have 65535 TCP/UDP ports in total; many are *well-known* (the first 1024).

**Key points**

* Ports map network traffic to the right application on the host.
* If you don’t know the open ports you don’t know which services exist — you can’t attack what you don’t know.
* `nmap` is the industry standard tool for port scanning and initial enumeration.

**Quick answers (from room)**

* What networking constructs are used to direct traffic? **Ports**
* How many ports? **65535**
* How many are considered "well-known"? **1024**

---

## Task 3 — Nmap switches (command flags)

`nmap` runs from the terminal. Use `nmap -h` or `man nmap` for help. Below are the common switches you’ll see:

**Essential switches (with examples)**

```bash
# SYN scan (half-open / stealth) - requires sudo to send raw packets
sudo nmap -sS <target>

# TCP Connect (full connect)
nmap -sT <target>

# UDP scan
sudo nmap -sU <target>

# Service/version detection
sudo nmap -sV <target>

# OS detection / aggressive (includes scripts, traceroute, version detection)
sudo nmap -A <target>

# Verbosity (increase output)
nmap -v <target>
nmap -vv <target>   # even more verbose

# Save results in multiple formats (normal, XML, grepable)
nmap -oA results <target>   # creates results.nmap, results.xml, results.gnmap
nmap -oN results.nmap <target>   # "normal" format
nmap -oG results.gnmap <target>  # grepable format

# Timing template (T0..T5, higher is faster but noisier)
nmap -T5 <target>

# Port selection
nmap -p 80 <target>
nmap -p 1000-1500 <target>
nmap -p- <target>    # scan all ports (1-65535)
nmap --top-ports 20 <target>  # scan top 20 commonly used ports

# NSE scripts
nmap --script <script-name> -p <port> <target>
nmap --script=vuln <target>    # run scripts in 'vuln' category
nmap --script-help <script-name>  # show built-in help for a script

# Script arguments (comma separated)
nmap -p 80 --script http-put --script-args http-put.url='/dav/shell.php',http-put.file='./shell.php' <target>

# Do not ping (treat host as alive / bypass ICMP filter)
nmap -Pn <target>

# Output useful when reporting:
nmap -sS -sV -A -p- -oA scan_results <target>
```

**Answers from the room (switches):**

* SYN scan: `-sS`
* UDP scan: `-sU`
* Detect OS: `-O`
* Detect versions: `-sV`
* Verbosity: `-v` (two levels: `-vv`)
* Save 3 major formats: `-oA`
* Normal format: `-oN`
* Grepable: `-oG`
* Aggressive: `-A`
* Timing level 5: `-T5`
* Single port: `-p 80`
* Port range: `-p 1000-1500`
* All ports: `-p-`
* Script activation: `--script` (e.g., `--script=vuln`)

---

## Task 4 — Scan Types (overview)

Nmap supports many scan types; primary ones:

* **TCP Connect scan** (`-sT`) — uses OS network stack to create full connection (three-way handshake). Works without raw sockets (no sudo) but is noisier / logged.
* **SYN scan** (`-sS`) — half-open (“stealth”) — sends SYN, looks for SYN/ACK then sends RST. Faster and stealthier; requires raw sockets (sudo).
* **UDP scan** (`-sU`) — UDP is connectionless; lack of response commonly reported as `open|filtered`. Slower.

Less common stealthy scans:

* **NULL scan** (`-sN`) — sends packet with no flags set.
* **FIN scan** (`-sF`) — sends FIN flag.
* **Xmas scan** (`-sX`) — sets FIN, PSH, URG (looks like a blinking tree in Wireshark).

Nmap also does ICMP / ping sweeps (`-sn`) to map alive hosts.

---

## Task 5 — TCP Connect scans (`-sT`) — explanation

**Three-way handshake recap**

1. Client -> Server: `SYN`
2. Server -> Client: `SYN/ACK`
3. Client -> Server: `ACK`

`-sT` performs the full handshake per port. Based on responses:

* **SYN/ACK** → port **open**
* **RST** → port **closed**
* **No response** → port **filtered** (likely firewall drops)

**RFC note**: RFC 9293 describes expected behavior (e.g., closed ports respond with a reset).

---

## Task 6 — SYN scans (`-sS`) — explanation

`-sS` sends SYN, if SYN/ACK returned Nmap marks open and sends **RST** to avoid completing handshake. If RST returned → closed. If no response → filtered. Advantages:

* Faster, stealthier; often not logged by applications.
  Disadvantages:
* Requires sudo (raw sockets).
* Some unstable services may crash on SYN floods.

**Room Q/A**: SYN is also called *Half-open* / *Stealth*. Can you use SYN without sudo? **No** (not reliably — needs raw packet privileges).

---

## Task 7 — UDP scans (`-sU`)

UDP is connectionless. Behavior:

* **No response** → `open|filtered` (could be open but no response).
* **ICMP port unreachable** → `closed`.
* Some services respond to protocol-specific payloads; Nmap will send special payloads for well-known services to elicit a reply.

Because UDP lacks ACKs, UDP scans are slow; use `--top-ports <n>` or `--top-ports 20` to speed up.

**Room Q/A**

* If UDP port doesn’t respond: **open|filtered**
* Closed UDP port response protocol: **ICMP**

---

## Task 8 — NULL, FIN, Xmas

These send malformed or unusual flag combinations to try to bypass stateful firewalls/IDS:

* **NULL (`-sN`)**: no flags.
* **FIN (`-sF`)**: FIN flag only.
* **Xmas (`-sX`)**: sets FIN, PSH, URG (looks like a blinking tree in packet captures).

RFC expects closed ports to reply with RST. Some OS (esp. older Unix) behave differently. Microsoft Windows often replies RST to many malformed probes, showing ports as closed even if they may be open.

**Uses**: firewall evasion / stealth. Modern IDS may detect these too.

---

## Task 9 — ICMP / ping sweep (`-sn`)

`-sn` disables port scanning and relies on ICMP echo and ARP (local) to detect live hosts.

Examples:

```bash
# Ping sweep a range (hyphen)
nmap -sn 192.168.0.1-254

# Ping sweep with CIDR
nmap -sn 192.168.0.0/24
```

Note: On Windows hosts that block ICMP, results may show hosts as down even when they are up. Use `-Pn` to skip host discovery and assume hosts are up.

**Room Q/A**

* Example for /16 (172.16.0.0/16):
  `nmap -sn 172.16.0.0/16`

---

## Task 10 — NSE (Overview)

**Nmap Scripting Engine (NSE)** extends Nmap with Lua scripts. Categories:

* `safe` — won’t harm target
* `intrusive` — may affect target
* `vuln` — vulnerability checks
* `exploit` — attempt exploitation
* `auth` — authentication checks
* `brute` — brute force
* `discovery` — info gathering

You can run categories or specific scripts:

```bash
# run all vuln scripts
nmap --script=vuln <target>

# run a specific script
nmap --script smb-os-discovery -p445 <target>
```

**Room Q/A**

* What language are NSE scripts in? **Lua**
* Category to avoid in production? **intrusive**

---

## Task 11 — Working with the NSE

Run specific scripts and pass arguments:

```bash
# Specific script
nmap --script=http-fileupload-exploiter -p80 <target>

# Script args example (http-put)
nmap -p 80 --script http-put --script-args http-put.url='/dav/shell.php',http-put.file='./shell.php' <target>
```

Multiple scripts: separate with comma

```bash
nmap --script smb-enum-users,smb-enum-shares -p445 <target>
```

Use `nmap --script-help <script-name>` to see local help for a script.

**Room Q/A**

* Example answer in room: `ftp-anon.nse` supports optional argument `maxlist` (the room’s Q had `maxlist`).

---

## Task 12 — Searching for scripts

Local scripts stored in:

```
/usr/share/nmap/scripts
```

Nmap keeps an index at:

```
/usr/share/nmap/scripts/script.db
```

To find scripts:

```bash
grep "ftp" /usr/share/nmap/scripts/script.db
ls -l /usr/share/nmap/scripts/*ftp*
```

If script missing: `sudo apt update && sudo apt install nmap` or download directly:

```bash
sudo wget -O /usr/share/nmap/scripts/<script-name>.nse https://svn.nmap.org/nmap/scripts/<script-name>.nse
sudo nmap --script-updatedb  # refresh script.db
```

**Room Q/A**

* Script that detects underlying OS of SMB server: `smb-os-discovery.nse`
* The script `smb-brute` depends on external things like credentials/wordlists (room question: "what does it depend on?" — `smb-brute` depends on username/password lists or provided credentials).

---

## Task 13 — Firewall evasion

Common useful switches:

* `-Pn` — do not ping first (treat host as up) — bypasses ICMP block.
* `-f` — fragment packets (split into small pieces) — can evade some IDS/IPS.
* `--mtu <num>` — set MTU size to fragment differently.
* `--scan-delay <ms>` — add delay between probes to avoid time-based IDS triggers.
* `--data-length <n>` — append random data of given length to packets.
* `--badsum` — set an invalid checksum (may provoke responses from firewalls, but real TCP stacks drop it).

**Room Q/A**

* Which protocol often blocked (requiring `-Pn`)? **ICMP**
* Nmap switch to append random data: `--data-length`

---

## Task 14 — Practical

(Perform scans against the attached VM. Machine IP shown in Task 1.)

Common lab commands:

```bash
# 1) Ping / ICMP check
ping -c 4 <MACHINE_IP>

# 2) Top ports UDP scan
sudo nmap -sU --top-ports 20 -Pn <MACHINE_IP> -oN udp_top20.nmap

# 3) SYN scan + version on first 5000 ports
sudo nmap -sS -sV -p1-5000 -T4 -oN syn_5000.nmap <MACHINE_IP>

# 4) Xmas scan on first 999 ports (example)
sudo nmap -sX -p1-999 -Pn <MACHINE_IP> -oN xmas_scan.nmap

# 5) Run ftp-anon script on service
nmap -sS -sV --script=ftp-anon -p 21 <MACHINE_IP>
```

**Room answers (practical):**

* Does target respond to ICMP ping? **N**
* Xmas scan on first 999 ports — number shown open/filtered: **999** (room exercise)
* TCP SYN scan first 5000 ports — how many shown open? **5** (room)
* Can Nmap login to FTP server on port 21 with `ftp-anon`? **Y**

(Your lab output may vary — use the provided machine in the room.)

---

## Task 15 — Conclusion

You’ve completed the Further Nmap room: practice the commands, read Nmap docs, build a scripts workflow and always save your results with `-oA` for reporting and reproducibility.

---

## Quick Reference — Packet/flag behavior (line-by-line breakdown)

**Three-way handshake (how Nmap infers state)**

1. **Client → Server: SYN**

   * Means "I want to open a connection".
2. **Server → Client: SYN/ACK**

   * Server accepts — indicates **open** port. Nmap marks `open` (SYN scan) and sends RST to avoid completing handshake.
3. **Client → Server: ACK**

   * Handshake complete (TCP Connect scan). Then client may send data.

**Server responses used by Nmap**

* **SYN/ACK** → **open**
* **RST** → **closed**
* **No response** → **filtered** (firewall dropped packet)
* **ICMP unreachable** → **closed (UDP)** or **filtered** (varies)

**SYN scan behavior**:

* Send SYN → if SYN/ACK returned, send RST to tear down (half-open). If RST returned → closed.

**NULL/FIN/Xmas**:

* Send malformed / unusual flags. RFC says closed ports should respond with RST. If an OS responds RST for everything (e.g., Windows), scans may show all ports closed — watch out and corroborate with other methods.

---

### Final notes

* Use `-sS -sV -p- -oA <name> <target>` as a standard fast enumeration template (with sudo).
* Use NSE carefully — some scripts are intrusive.
* If host seems down but you know it’s up, try `-Pn` or ARP-based discovery if local.

---
